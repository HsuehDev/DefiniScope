# 互動式句子引用功能實現指南

## 1. 功能概述

互動式句子引用功能允許使用者在查看系統回答時，能夠：
- 查看引用的來源文件和頁碼
- 懸停在引用上查看完整引用內容
- 點擊引用查看上下文
- 跳轉至PDF中的原始位置並高亮顯示

## 2. 組件架構

我們的互動式句子引用功能由以下組件構成：

### 2.1 核心視覺組件

1. **ReferenceTag** - 引用標籤組件
   - 顯示來源文件名、頁碼和定義類型
   - 支持點擊和懸停事件
   - 根據引用類型顯示不同顏色（概念型定義/操作型定義）

2. **ReferencePopover** - 引用懸停預覽組件
   - 當鼠標懸停在引用標籤上時顯示
   - 顯示完整的引用句子內容
   - 提供文件名、頁碼和定義類型信息

3. **ReferenceContextViewer** - 上下文查看器組件
   - 顯示引用句子的前後文
   - 提供跳轉到PDF的選項
   - 以模態框形式展示

4. **PDFViewer** - PDF預覽組件
   - 顯示原始PDF文件
   - 支持頁面導航和縮放
   - 高亮顯示引用的句子

5. **PDFPreviewModal** - PDF預覽模態框
   - 包裝PDFViewer組件
   - 提供標題欄和關閉按鈕
   - 顯示當前頁碼和引用信息

### 2.2 數據管理

1. **useReferenceManager** - 引用管理Hook
   - 集中管理引用相關的狀態和交互邏輯
   - 處理引用的懸停、點擊、上下文查看和PDF預覽
   - 提供統一的接口供其他組件使用

2. **API服務**
   - 提供獲取句子上下文的函數
   - 提供獲取PDF預覽URL的函數
   - 處理與後端的數據交互

## 3. 數據流和交互邏輯

### 3.1 引用標籤點擊流程

```
用戶點擊引用標籤
    ↓
handleReferenceClick()被調用
    ↓
設置selectedReference狀態
    ↓
顯示ReferenceContextViewer模態框
    ↓
從API獲取上下文數據
    ↓
顯示上下文數據
    ↓
用戶可選擇「在PDF中查看」
    ↓
handleViewPdf()被調用
    ↓
關閉上下文查看器，顯示PDF預覽
```

### 3.2 引用懸停預覽流程

```
用戶將鼠標懸停在引用標籤上
    ↓
handleReferenceHover()被調用
    ↓
設置hoveredReference和popoverPosition狀態
    ↓
顯示ReferencePopover組件
    ↓
2秒後自動隱藏(或用戶移開鼠標)
```

### 3.3 PDF預覽和高亮流程

```
用戶點擊「在PDF中查看」
    ↓
handleViewPdf()被調用
    ↓
顯示PDFPreviewModal
    ↓
PDFViewer組件加載PDF文件
    ↓
渲染當前頁面
    ↓
從API獲取句子在PDF中的位置
    ↓
繪製高亮矩形
    ↓
滾動到高亮位置
```

## 4. 視覺設計與用戶體驗考量

### 4.1 引用標籤設計

- **顏色編碼**：使用不同顏色區分概念型定義(CD)和操作型定義(OD)
- **懸停效果**：輕微放大和陰影效果，提示可點擊
- **緊湊布局**：在有限空間內顯示足夠信息
- **內容截斷**：長文件名會被截斷並顯示省略號

### 4.2 上下文查看器設計

- **高亮當前句**：用黃底突出顯示引用的句子
- **前後文顯示**：灰色文本顯示上下文
- **清晰界面**：簡潔的標題欄和關閉按鈕
- **直觀跳轉**：明確的「在PDF中查看」按鈕

### 4.3 PDF預覽設計

- **完整工具欄**：頁面導航、頁碼輸入和縮放控制
- **高亮效果**：半透明黃色背景標記引用句子
- **自動滾動**：自動定位到高亮句子位置
- **響應式布局**：適應不同屏幕尺寸

## 5. 與現有系統的整合

### 5.1 與聊天界面整合

`ChatMessage`組件集成了引用功能：
- 判斷消息類型，僅在系統回答中顯示引用
- 將引用標籤添加到消息底部
- 使用useReferenceManager管理引用交互

### 5.2 與後端API整合

我們的前端組件依賴以下API端點：
- `/api/files/{file_uuid}/sentences/{sentence_uuid}/context` - 獲取句子上下文
- `/api/files/{file_uuid}/sentences/{sentence_uuid}/position` - 獲取句子在PDF中的位置
- `/api/files/{file_uuid}/preview` - 預覽PDF文件
- `/api/files/{file_uuid}/download` - 下載PDF原文件

## 6. 擴展性與未來優化

### 6.1 可能的擴展

- **批量查看引用**：允許同時查看多個引用的上下文
- **引用比較**：並排顯示多個引用進行比較
- **引用筆記**：允許用戶添加自己的筆記到引用
- **引用搜索**：跨文件搜索特定概念的所有引用

### 6.2 性能優化

- **懶加載PDFjs**：僅在需要時加載PDF渲染庫
- **緩存PDF渲染**：避免重複渲染相同頁面
- **虛擬化長文本**：對大量上下文使用虛擬滾動
- **預加載策略**：可能的話預加載用戶可能查看的PDF頁面

## 7. 總結

互動式句子引用功能通過提供豐富的交互體驗，極大地提升了系統回答的可信度和可追溯性。用戶可以輕松查看引用的原始上下文，確認系統回答的準確性，並深入閱讀原始文獻以獲取更多信息。

通過精心設計的視覺界面和流暢的交互流程，我們確保用戶在使用過程中能夠直觀地理解系統提供的引用，並能夠輕松地在引用、上下文和原始PDF之間無縫切換。 