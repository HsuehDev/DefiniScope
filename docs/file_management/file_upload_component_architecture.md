# 檔案上傳功能架構設計

## 組件結構關係圖

```
                                    ┌───────────────────┐
                                    │                   │
                                    │   FileUploadZone  │
                                    │                   │
                                    └──────────┬────────┘
                                               │
                                               │
                 ┌───────────────────┬─────────┴──────────┬────────────────────┐
                 │                   │                    │                    │
    ┌────────────▼───────────┐      ▼                    ▼                    ▼
    │                        │ ┌─────────────┐ ┌───────────────────┐ ┌────────────────────┐
    │     useDropzone        │ │ useFileUpload│ │ UploadProgressBar │ │ UploadTimeoutWarning│
    │  (react-dropzone)      │ │ (Hook)       │ │                   │ │                    │
    └────────────────────────┘ └──────┬───────┘ └───────────────────┘ └────────────────────┘
                                      │
                              ┌───────┴───────┐
                              │               │
                          ┌───▼───┐      ┌────▼─────┐
                          │       │      │          │
                          │ axios │      │TanStack  │
                          │       │      │Query     │
                          └───────┘      └──────────┘
```

## 數據流向說明

1. **使用者交互流程**
   - 使用者通過拖放或點擊按鈕選擇檔案
   - `useDropzone` Hook 處理檔案選擇事件
   - 選擇的檔案傳給 `useFileUpload` Hook 進行上傳前的驗證
   - 檔案驗證通過後，加入上傳佇列並顯示上傳進度
   - 上傳過程中顯示進度、速度和剩餘時間
   - 如果接近超時，顯示警告
   - 上傳完成後更新狀態

2. **核心數據流**
   - `FileUploadZone` → `useFileUpload` → API 請求 → 後端伺服器
   - 後端伺服器返回結果 → `useFileUpload` → 狀態更新 → `FileUploadZone` 重新渲染

3. **上傳狀態流**
   - `useFileUpload` 管理所有檔案的上傳狀態
   - 每個檔案的狀態包含：上傳進度、速度、剩餘時間、錯誤訊息等
   - 狀態通過 React 的 props 傳遞給 `UploadProgressBar` 和 `UploadTimeoutWarning` 組件
   - 組件根據不同狀態顯示不同的 UI

## 分片上傳和斷點續傳實現

1. **分片上傳流程**
   ```
   ┌─────────────┐   ┌────────────────────┐   ┌────────────────┐
   │ 初始化上傳   │ → │ 上傳多個分片(並行)  │ → │  完成上傳     │
   └─────────────┘   └────────────────────┘   └────────────────┘
         │                     │                      │
         ▼                     ▼                      ▼
   ┌─────────────┐   ┌────────────────────┐   ┌────────────────┐
   │ 獲取上傳ID   │   │  各分片獨立上傳    │   │ 合併所有分片   │
   └─────────────┘   └────────────────────┘   └────────────────┘
   ```

2. **分片生成**
   - 使用 `File.slice()` 方法將檔案切分成多個小塊 (默認 1MB)
   - 每個分片包含：索引、數據塊、開始/結束位元組等信息
   - 為每個分片創建上傳任務

3. **斷點續傳機制**
   - 持續追踪已上傳的分片狀態
   - 發生網絡中斷時，自動暫停上傳
   - 網絡恢復時，獲取已上傳的分片列表
   - 只上傳未完成的分片
   - 使用者可以手動暫停和繼續上傳

4. **超時處理**
   - 追踪每個上傳任務的開始時間
   - 定期檢查是否已接近 10 分鐘超時限制
   - 接近超時時 (剩餘 2 分鐘) 顯示警告
   - 達到超時限制時自動取消上傳

## 錯誤處理與重試機制

1. **上傳錯誤處理**
   - 每個分片有獨立的重試計數
   - 上傳失敗時自動重試 (最多 3 次)
   - 顯示友好的錯誤訊息
   - 網絡問題導致的錯誤可由使用者手動重試

2. **狀態恢復**
   - 頁面刷新後可以從 localStorage 恢復上傳狀態
   - 會話期間保持上傳歷史記錄

## 性能優化

1. **並行上傳控制**
   - 限制同時上傳的文件數 (默認 3 個)
   - 限制每個文件的並行分片數 (默認 3 個)
   - 動態調整並行數以優化上傳速度

2. **內存優化**
   - 釋放已上傳分片的內存引用
   - 使用 Web Worker 處理大文件分片

3. **用戶體驗優化**
   - 精確的進度和時間計算
   - 優雅的錯誤和警告展示
   - 響應式設計適配不同屏幕大小 