# PDF預覽與句子高亮功能測試方案

## 一、概述

本文檔詳細描述了PDF預覽及句子高亮功能的全面測試策略。測試範圍包括PDF渲染、頁面導航、縮放功能以及句子高亮顯示，重點關注從URL參數跳轉到特定頁面並高亮句子的功能測試。

## 二、測試架構

測試架構分為三個層次：

1. **單元測試**：使用Vitest和JSDOM測試各組件的功能邏輯
2. **集成測試**：測試組件間的互動和協作
3. **端到端測試**：使用Playwright測試真實瀏覽器環境下的用戶體驗

## 三、測試環境設置

### 3.1 單元測試環境

- **框架**：Vitest + React Testing Library
- **模擬工具**：MSW (Mock Service Worker) 用於模擬API請求
- **環境**：JSDOM虛擬DOM環境
- **測試運行方式**：`npm run test:vitest`

### 3.2 端到端測試環境

- **框架**：Playwright
- **瀏覽器**：Chrome, Firefox, Safari (桌面版和移動版)
- **測試運行方式**：`npm run test:e2e`
- **視覺回歸測試**：`npm run test:visual`

### 3.3 PDF.js模擬方案

為避免在單元測試中實際渲染PDF的複雜性，我們設計了PDF.js的模擬實現，主要內容包括：

- 模擬Document和Page組件的基本功能
- 模擬頁面載入和渲染事件
- 模擬文本層和文本節點
- 模擬高亮功能所需的DOM操作

## 四、單元測試策略

### 4.1 PDFViewer組件測試

**測試範圍**：
- 基本渲染功能
- 頁面導航功能
- 縮放和旋轉功能
- URL參數處理
- 句子高亮功能
- 鍵盤操作支援
- 錯誤處理

**測試方法**：
- 模擬API請求獲取PDF預覽URL
- 模擬PDF.js的Document和Page組件
- 模擬頁面導航和高亮操作
- 驗證DOM元素的渲染

### 4.2 PDFHighlighter組件測試

**測試範圍**：
- 文本搜索和高亮邏輯
- 多次嘗試查找機制
- 邊界情況處理

**測試方法**：
- 創建模擬的頁面容器和文本層
- 驗證高亮元素的創建和樣式
- 測試找不到文本時的行為
- 測試延遲加載文本的情況

### 4.3 PDFPreviewModal組件測試

**測試範圍**：
- 模態框顯示和隱藏邏輯
- 文件信息獲取
- 按鈕和快捷鍵關閉功能

**測試方法**：
- 模擬PDFViewer組件
- 測試不同的isOpen狀態
- 模擬鍵盤事件
- 驗證文件信息的獲取和顯示

## 五、端到端測試策略

### 5.1 基本功能測試

**測試範圍**：
- 用戶登入後打開PDF
- 基本的頁面導航
- 縮放和旋轉操作
- 縮略圖側邊欄交互

**測試方法**：
- 完整模擬用戶操作流程
- 驗證頁面內容和狀態變化

### 5.2 引用跳轉與高亮測試

**測試範圍**：
- 從聊天回答中的引用跳轉到PDF
- 高亮特定句子
- 頁面自動跳轉到正確位置

**測試方法**：
- 模擬聊天查詢和回應
- 監聽網絡請求確認API調用
- 驗證高亮元素的存在和位置

### 5.3 URL參數測試

**測試範圍**：
- 通過URL參數直接打開特定頁面
- 高亮指定句子

**測試方法**：
- 直接導航到帶參數的URL
- 驗證頁碼和高亮狀態

### 5.4 響應式設計測試

**測試範圍**：
- 在不同屏幕尺寸下的布局適應
- 移動設備上的操作體驗

**測試方法**：
- 調整視口大小
- 測試關鍵元素的可見性和可用性

## 六、視覺回歸測試策略

### 6.1 測試範圍

- PDF基本渲染外觀
- 頁面導航後的渲染效果
- 句子高亮的視覺效果
- 不同屏幕尺寸下的響應式布局
- 跨瀏覽器渲染一致性

### 6.2 實現方法

- 使用Playwright的截圖比較功能
- 設置適當的閾值和像素差異容忍度
- 分別測試桌面和移動設備的視覺效果
- 使用命名規則區分不同瀏覽器和設備的截圖

### 6.3 基線管理

- 基線截圖存儲在專用目錄
- 使用`npm run test:visual:update`更新基線
- 在CI流程中運行視覺比較測試

## 七、性能測試策略

### 7.1 測試範圍

- PDF加載時間
- 渲染效率
- 頁面切換性能
- 高亮操作響應時間

### 7.2 實現方法

- 使用Performance API收集性能指標
- 設置性能指標閾值
- 在不同設備類型上進行測試
- 比較多頁PDF與單頁PDF的性能差異

### 7.3 性能指標

- PDF載入時間：預期 < 5秒
- 頁面切換時間：預期 < 1秒
- 高亮顯示時間：預期 < 1秒

## 八、跨瀏覽器兼容性測試

### 8.1 瀏覽器矩陣

- Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)
- 移動端Chrome和Safari

### 8.2 測試方法

- 使用Playwright的多瀏覽器支持
- 檢查關鍵功能在所有瀏覽器上的行為一致性
- 驗證視覺效果的差異在可接受範圍內

### 8.3 差異處理策略

- 記錄已知瀏覽器差異
- 為特定瀏覽器實現修復或替代方案
- 在無法保持完全一致時優先確保功能可用性

## 九、實現細節

### 9.1 模擬實現關鍵點

1. **PDF.js模擬**:
   - 模擬Document和Page組件的渲染和事件
   - 提供虛擬DOM結構供測試交互
   - 模擬文本層和高亮功能

2. **API請求模擬**:
   - 模擬PDF文件預覽請求
   - 模擬句子引用信息獲取
   - 提供可控的響應數據

3. **DOM操作模擬**:
   - 模擬getBoundingClientRect方法
   - 模擬DOM查詢和操作方法
   - 模擬元素視圖滾動功能

### 9.2 測試數據管理

- 使用固定的測試檔案UUID
- 使用固定的測試句子UUID
- 在端到端測試中使用固定的測試帳戶

## 十、測試執行與CI集成

### 10.1 本地執行

- 單元測試: `npm run test:vitest`
- 端到端測試: `npm run test:e2e`
- 視覺回歸測試: `npm run test:visual`
- 所有測試: `npm run test:all`

### 10.2 CI環境執行

- 每次推送自動運行單元測試
- Pull Request時運行端到端測試
- 使用Playwright的CI模式減少資源使用
- 生成測試報告與截圖

## 十一、測試維護策略

### 11.1 測試代碼維護

- 遵循模塊化設計原則
- 共享測試工具和模擬實現
- 定期更新視覺回歸基線
- 隨組件變更同步更新測試用例

### 11.2 測試文檔維護

- 記錄已知問題和特殊處理
- 更新測試覆蓋範圍和執行指南
- 維護測試環境設置說明

## 十二、總結

本測試方案通過單元測試、端到端測試和視覺回歸測試全面覆蓋了PDF預覽和句子高亮功能，確保其在各種環境下的穩定性和一致性。通過模擬實現避免了實際PDF渲染的複雜性，同時保持了測試的有效性。測試覆蓋了從基本渲染到特定頁面跳轉和句子高亮的所有關鍵功能。 