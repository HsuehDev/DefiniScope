# 聊天界面測試策略

## 1. 概述

本文檔詳細說明聊天界面組件的測試策略，包括單元測試、整合測試和端到端測試方案。測試重點放在消息顯示、輸入框交互及快捷鍵功能，特別關注中文輸入法下的輸入體驗。

## 2. 測試範圍

### 2.1 功能測試範圍

- **消息顯示功能**：測試不同類型消息的渲染，包括用戶消息和助手消息
- **參考引用功能**：測試引用原文的顯示和交互
- **輸入框功能**：測試文本輸入、發送和快捷鍵操作
- **自動滾動功能**：測試長對話下的自動滾動行為
- **處理狀態顯示**：測試處理進度顯示和狀態更新
- **中文輸入法兼容性**：測試中文輸入法環境下的快捷鍵行為

### 2.2 測試組件

- `ChatContainer`：聊天整體容器組件
- `ChatMessage`：各類消息顯示組件
- `ChatInput`：用戶輸入區域組件
- `ReferenceDisplay`：引用顯示組件

## 3. 測試方法與工具

### 3.1 單元測試 (Vitest + React Testing Library)

- 使用 Vitest 作為測試運行器
- 使用 React Testing Library 進行組件測試
- 模擬組件依賴，如 WebSocket 連接和 API 調用
- 驗證組件渲染輸出和事件處理

### 3.2 端到端測試 (Playwright)

- 使用 Playwright 測試瀏覽器交互
- 模擬真實用戶操作和完整工作流程
- 跨瀏覽器測試（Chrome, Firefox, Safari）
- 測試不同輸入法和操作系統環境下的交互

## 4. 重點測試方案

### 4.1 ChatMessageList 組件測試

#### 測試重點：
- 正確渲染用戶消息和助手消息
- 顯示引用句子和參考信息
- 長消息的格式保持和自動斷行
- 自動滾動到最新消息
- 處理中狀態的顯示

#### 測試技術：
- 使用 `render` 函數渲染組件
- 使用 `screen.getByText` 檢查文本內容
- 模擬 `scrollIntoView` 方法驗證滾動行為
- 檢查 DOM 結構和樣式類

### 4.2 ChatInput 組件測試

#### 測試重點：
- 基本輸入功能
- Enter 發送消息
- Shift+Enter 換行功能
- 中文輸入法下的快捷鍵行為
- 輸入框高度自動調整
- 輸入驗證和空消息處理
- 處理中狀態的禁用行為

#### 測試技術：
- 使用 `userEvent` 模擬用戶輸入
- 使用 `fireEvent` 模擬鍵盤事件
- 模擬 IME 輸入事件 (compositionstart, compositionend)
- 檢查輸入值和回調函數調用

### 4.3 中文輸入法下的快捷鍵測試方案

中文輸入法環境下的快捷鍵測試是一個特殊挑戰，因為輸入法狀態難以在測試環境中精確模擬。我們的方案包括：

#### 單元測試策略：
1. **模擬輸入法事件**：
   - 使用 `fireEvent` 觸發 `compositionstart` 事件模擬中文輸入開始
   - 在輸入法組合狀態中模擬按下 Enter 鍵
   - 觸發 `compositionend` 事件模擬中文輸入結束
   - 驗證在組合狀態中不應觸發發送行為

2. **測試輸入法狀態管理**：
   - 驗證組件正確追踪輸入法狀態
   - 測試狀態切換時的行為正確性

#### 端到端測試策略：
1. **瀏覽器中的模擬**：
   - 使用 Playwright 的 `page.evaluate()` 方法直接在瀏覽器執行腳本
   - 手動觸發 compositionstart 和 compositionend 事件
   - 模擬真實的中文輸入過程

2. **跨平台測試**：
   - 在 Windows、macOS 和 Linux 系統下的測試場景
   - 測試不同中文輸入法：
     - Windows: 微軟拼音、搜狗拼音
     - macOS: 內建中文輸入法
     - Linux: IBus、Fcitx 等

### 4.4 特殊格式內容測試

#### 長消息測試：
- 生成非常長的消息（例如重複文本或長段落）
- 檢查渲染是否正確（無截斷）
- 驗證自動滾動行為

#### 特殊字符測試：
- 包含 HTML 標簽的消息
- 包含 URL 和電子郵件地址
- 包含表情符號和特殊符號
- 包含代碼片段或其他格式化內容

#### 多行消息測試：
- 測試換行符的正確渲染
- 測試段落和格式保持

## 5. 端到端工作流程測試

### 5.1 基本聊天流程
測試從輸入問題到接收回答的完整流程，包括：
- 輸入並發送問題
- 觀察處理中狀態顯示
- 驗證回答顯示和格式
- 檢查引用功能

### 5.2 連續對話測試
測試多輪對話情況，驗證：
- 歷史消息保持
- 上下文相關回答
- 長對話下的性能和滾動行為

### 5.3 錯誤處理測試
- 網絡連接中斷
- 後端回應超時
- 無效輸入處理

## 6. 跨瀏覽器兼容性測試

使用 Playwright 進行跨瀏覽器測試，覆蓋：
- Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)
- Edge (最新版)

針對每個瀏覽器，重點關注：
- DOM 渲染一致性
- 輸入法兼容性
- 鍵盤事件處理
- 滾動行為
- 性能表現

## 7. 測試自動化與 CI/CD 整合

- 在 Pull Request 階段自動運行單元測試
- 每日在多平台執行端到端測試
- 生成詳細測試報告，包括覆蓋率和失敗案例
- 視覺回歸測試，確保 UI 一致性

## 8. 測試場景與案例矩陣

| 測試類別 | 測試重點 | 單元測試 | 端到端測試 | 測試工具 |
|---------|---------|---------|-----------|---------|
| 消息渲染 | 不同類型消息顯示 | ✅ | ✅ | Vitest, Playwright |
| 消息渲染 | 引用顯示 | ✅ | ✅ | Vitest, Playwright |
| 消息渲染 | 長消息和特殊格式 | ✅ | ✅ | Vitest, Playwright |
| 輸入交互 | Enter 發送消息 | ✅ | ✅ | Vitest, Playwright |
| 輸入交互 | Shift+Enter 換行 | ✅ | ✅ | Vitest, Playwright |
| 輸入交互 | 中文輸入法兼容性 | ✅ | ✅ | Vitest, Playwright |
| 滾動行為 | 新消息自動滾動 | ✅ | ✅ | Vitest, Playwright |
| 狀態處理 | 處理中狀態顯示 | ✅ | ✅ | Vitest, Playwright |
| 狀態處理 | 發送按鈕禁用邏輯 | ✅ | ✅ | Vitest, Playwright |

## 9. 測試數據與模擬策略

### 9.1 模擬數據
- 預定義的對話歷史
- 模擬 AI 回應
- 模擬引用句子
- 各種長度和格式的消息

### 9.2 API 模擬
- 使用 MSW (Mock Service Worker) 攔截 API 請求
- 定義各種 API 響應情境
- 模擬網絡延遲和錯誤

### 9.3 WebSocket 模擬
- 模擬 WebSocket 連接
- 模擬進度更新事件
- 模擬不同處理階段

## 10. 總結與建議

- 重點關注中文輸入法下的快捷鍵行為，這是一個容易出問題的區域
- 對於長消息和引用顯示進行充分測試，確保良好的用戶體驗
- 在實際用戶環境（不同操作系統、輸入法和瀏覽器）進行手動測試補充
- 定期進行全流程測試，確保系統整體功能正常運作
- 考慮添加性能測試，特別是對於長對話的渲染和滾動性能 